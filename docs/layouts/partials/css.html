{{ $serverMode   := site.IsServer }}
{{ $includePaths := slice "node_modules" }}
{{ $sass         := "sass/style.sass" }}
{{ $cssOutput    := "css/style.css" }}
{{ $devOpts      := dict "targetPath" $cssOutput "includePaths" $includePaths "enableSourceMap" true }}
{{ $prodOpts     := dict "targetPath" $cssOutput "includePaths" $includePaths "outputStyle" "compressed" }}
{{ $cssOpts      := cond $serverMode $devOpts $prodOpts }}
{{ $postCssOpts  := dict "inlineImports" true }}
{{ $css          := resources.Get $sass | resources.ExecuteAsTemplate $sass . | toCSS $cssOpts | postCSS $postCssOpts }}

{{/* Some Sass needs to be handled separately, as PurgeCSS will eliminate all of these
     classes since they're created at page load time by JavaScript */}}
{{ $unpurgedCss := resources.Get "sass/unpurged.sass" | toCSS (dict "targetPath" "css/unpurged.css" "outputStyle" "compressed") }}

{{/* Run CSS post-processing for production and preview builds */}}
{{ if $serverMode }}
<link rel="stylesheet" href="{{ $css.RelPermalink }}">
<link rel="stylesheet" href="{{ $unpurgedCss.RelPermalink }}">
{{ else }}
{{ $css = $css | fingerprint | resources.PostProcess }}
{{ $unpurgedCss = $unpurgedCss | fingerprint }}
<link rel="stylesheet" href="{{ $css.RelPermalink }}" integrity="{{ $css.Data.Integrity }}">
<link rel="stylesheet" href="{{ $unpurgedCss.RelPermalink }}" integrity="{{ $unpurgedCss.Data.Integrity }}">
{{ end }}

{{ if site.Home }}
{{ $diagramCss := resources.Get "css/diagram.css" | fingerprint }}
<link rel="stylesheet" href="{{ $diagramCss.RelPermalink }}" integrity="{{ $diagramCss.Data.Integrity }}">
{{ end }}