{{ $server := site.IsServer }}
{{ $includePaths := slice "node_modules" }}
{{ $cssOpts := cond $server (dict "includePaths" $includePaths "enableSourceMap" true) (dict "includePaths" $includePaths "outputStyle" "compressed") }}

{{/* Main site CSS (Tailwind, etc.) */}}
{{ template "sass-postcss" (dict "server" $server "input" "sass/style.sass" "output" "css/style.css" "ctx" . "css_opts" $cssOpts) }}

{{/* Non-purged CSS (no PostCSS) */}}
{{ template "sass" (dict "server" $server "input" "sass/unpurged.sass" "output" "css/unpurged.css" "ctx" . "css_opts" $cssOpts) }}

{{/* Main page animated Vector diagram */}}
{{ template "sass" (dict "server" $server "input" "sass/home.sass" "output" "css/home.css" "ctx" . "css_opts" $cssOpts) }}

{{ define "sass-postcss" }}
{{ $opts := merge .css_opts (dict "targetPath" .output) }}
{{ $postCssOpts := dict "inlineImports" true }}
{{ $css := resources.Get .input | resources.ExecuteAsTemplate .input .ctx | toCSS $opts | postCSS $postCssOpts }}
{{ if .server }}
<link rel="stylesheet" href="{{ $css.RelPermalink }}">
{{ else }}
{{ $css = $css | fingerprint }}
<link rel="stylesheet" href="{{ $css.RelPermalink }}" integrity="{{ $css.Data.Integrity }}">
{{ end }}
{{ end }}

{{ define "sass" }}
{{ $opts := merge .css_opts (dict "targetPath" .output) }}
{{ $css := resources.Get .input | resources.ExecuteAsTemplate .input .ctx | toCSS $opts }}
{{ if .server }}
<link rel="stylesheet" href="{{ $css.RelPermalink }}">
{{ else }}
{{ $css = $css | fingerprint }}
<link rel="stylesheet" href="{{ $css.RelPermalink }}" integrity="{{ $css.Data.Integrity }}">
{{ end }}
{{ end }}